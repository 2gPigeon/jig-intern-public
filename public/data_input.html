<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>購入データの入力</title>
    <link rel="stylesheet" href="data_input.css">
    <link rel="icon" href="favicon.ico">
    <!-- LeafletのCSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <h1>購入データの入力をしよう</h1>
    <div id="auth-box" style="margin-bottom: 12px;">
        <div id="auth-status" style="margin-bottom: 6px;">未ログイン</div>
        <div id="login-form">
            <input type="text" id="username" placeholder="ユーザー名" style="width: 160px;">
            <button type="button" id="login-button">ログイン</button>
        </div>
        <div id="logout-form" style="display: none;">
            <button type="button" id="logout-button">ログアウト</button>
        </div>
    </div>
    <form method="post">
        <label for="data">購入金額を入力してください:</label>
        <input type="number" id="data" name="data" max="1000000" min="1" required>円<br>
        
        <!-- 購入した場所の入力 -->
        <div class="location-section">
            <h3>購入した場所を選択してください</h3>
            <p>地図上でクリックするか、マーカーをドラッグして位置を指定してください</p>
            
            <!-- 地図を表示するコンテナ -->
            <div id="leaflet-map" style="height: 400px; width: 100%; display: none;"></div>
            
            <!-- 緯度経度の入力フィールド -->
            <div class="coordinates-input">
                <label for="latitude">緯度:</label>
                <input type="number" id="latitude" name="latitude" step="0.000001" max="90" min="-90" required>
                
                <label for="longitude">経度:</label>
                <input type="number" id="longitude" name="longitude" step="0.000001" max="180" min="-180" required>
            </div>
        </div>
        <div class="button-group">
            <button type="button" id="submit-button">送信</button>
            <button type="button" id="back-button" onclick="location.href='/'">戻る</button>
        </div>
    </form>

    <!-- LeafletのJS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, marker;
        let useLeaflet = false;
        
        // Leafletの初期化を試行
        function initializeLeafletMap() {
            try {
                if (typeof L !== 'undefined') {
                    // Leaflet地図の初期設定（大阪を中心に設定）
                    map = L.map('leaflet-map').setView([34.6937, 135.5023], 13);

                    // OpenStreetMapのタイルを追加
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    // ドラッグ可能なマーカーを初期位置に追加
                    marker = L.marker([34.6937, 135.5023], {
                        draggable: true
                    }).addTo(map);

                    // マーカーがドラッグされたときの処理
                    marker.on('dragend', function(e) {
                        const position = marker.getLatLng();
                        updateCoordinates(position.lat, position.lng);
                    });

                    // 地図をクリックしたときの処理
                    map.on('click', function(e) {
                        const lat = e.latlng.lat;
                        const lng = e.latlng.lng;

                        // マーカーの位置を更新
                        marker.setLatLng([lat, lng]);
                        updateCoordinates(lat, lng);
                    });

                    // Leaflet地図を表示
                    document.getElementById('leaflet-map').style.display = 'block';

                    // 地図のサイズを再計算
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 0);

                    useLeaflet = true;

                    // 初期値を設定
                    useCurrentLocation();
                    return true;
                }
            } catch (error) {
                console.log('Leafletの初期化に失敗:', error);
            }
            return false;
        }
        
        // 座標を更新する関数（共通）
        function updateCoordinates(lat, lng) {
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
            
            if (useLeaflet && marker) {
                marker.setLatLng([lat, lng]);
            } else if (window.updateSimpleMarker) {
                window.updateSimpleMarker(lat, lng);
            }
        }
        
        // 位置リセット
        function resetMarker() {
            if (useLeaflet) {
                document.getElementById('latitude').value = '';
                document.getElementById('longitude').value = '';
            } else {
                document.getElementById('marker').style.display = 'none';
                document.getElementById('latitude').value = '';
                document.getElementById('longitude').value = '';
            }
        }
        
        // 現在地取得
        function useCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    updateCoordinates(lat, lng);
                    
                    if (useLeaflet && map) {
                        map.setView([lat, lng], 13);
                    }
                }, function() {
                    alert('現在地を取得できませんでした。');
                });
            } else {
                alert('お使いのブラウザは位置情報サービスをサポートしていません。');
            }
        }
        
        // 入力フィールドの変更でマーカーを更新
        document.getElementById('latitude').addEventListener('input', updateMarkerFromInputs);
        document.getElementById('longitude').addEventListener('input', updateMarkerFromInputs);
        
        function updateMarkerFromInputs() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            
            if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                if (useLeaflet && marker) {
                    marker.setLatLng([lat, lng]);
                    map.setView([lat, lng]);
                } else if (window.updateSimpleMarker) {
                    window.updateSimpleMarker(lat, lng);
                }
            }
        }
        
        // ページ読み込み時の初期化
        window.addEventListener('load', function() {
            // まずLeafletの初期化を試行
            if (!initializeLeafletMap()) {
                // Leafletが使用できない場合は簡易地図を使用
                initializeSimpleMap();
            }
        });
        // 送信ボタンの活性・非活性

        document.addEventListener('DOMContentLoaded', function() {
            const dataInput = document.getElementById('data');
            const submitButton = document.getElementById('submit-button');

            function toggleSubmit() {
                submitButton.disabled = !dataInput.value;
            }

            // 入力時にボタンの活性/非活性を切り替え
            dataInput.addEventListener('input', toggleSubmit);

            // 初期状態もチェック
            toggleSubmit();
        });
        // 送信ボタンクリック時の処理
        async function ensureLoggedIn() {
            const res = await fetch('/me');
            if (res.ok) {
                const me = await res.json();
                document.getElementById('auth-status').textContent = `ログイン中: ${me.userId}`;
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('logout-form').style.display = 'block';
                document.getElementById('submit-button').disabled = false;
                return true;
            }
            document.getElementById('auth-status').textContent = '未ログイン';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('logout-form').style.display = 'none';
            document.getElementById('submit-button').disabled = true;
            return false;
        }

        document.getElementById('login-button').addEventListener('click', async function() {
            const username = document.getElementById('username').value.trim();
            if (!username) { alert('ユーザー名を入力してください'); return; }
            const res = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });
            if (res.ok) {
                await ensureLoggedIn();
            } else {
                alert('ログインに失敗しました');
            }
        });

        document.getElementById('logout-button').addEventListener('click', async function() {
            await fetch('/logout', { method: 'POST' });
            await ensureLoggedIn();
        });

        document.getElementById('submit-button').addEventListener('click', async function() {
            const loggedIn = await ensureLoggedIn();
            if (!loggedIn) { alert('送信にはログインが必要です'); return; }
            const data = document.getElementById('data').value;
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            fetch('/submit-data', {
                method: 'POST',
                body: JSON.stringify({ data, latitude, longitude }),
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    window.location.href = '/';
                } else if (response.status === 401) {
                    alert('ログインが必要です');
                } else {
                    alert('データの送信に失敗しました。');
                }
            });
        });

        // 初期状態で認証チェック
        ensureLoggedIn();
    </script>
    <div id="leaflet-map" style="height: 400px; width: 100%; display: none;"></div>
</body>
</html>